<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>课程管理</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet"/>
    <link id="bootstrap-rtl-link" href="" rel="stylesheet"/>
    <link href="/css/font-awesome.min.css" rel="stylesheet"/>
    <link href="/css/weather-icons.min.css" rel="stylesheet"/>

    <link
            href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300"
            rel="stylesheet" type="text/css">

    <link href="/css/demo.min.css" rel="stylesheet"/>
    <link href="/css/typicons.min.css" rel="stylesheet"/>
    <link href="/css/animate.min.css" rel="stylesheet"/>
    <link href="/css/bootstrap-table.css" rel="stylesheet"/>
    <link href="/css/toastr.css" rel="stylesheet"/>
    <link href="/css/fileinput.min.css" rel="stylesheet"/>

    <script src="/js/jquery-2.0.3.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/bootstrap-table.js?t=4"></script>
    <script src="/js/bootstrap-table-zh-CN.js"></script>
    <script src="/js/toastr.js"></script>
    <script src="/js/bootbox.min.js"></script>
    <script src="/js/bootstrap-datetimepicker.min.js"></script>
    <script src="/js/fileinput.min.js"></script>
    <script src="/js/fileinput_local_zh.js"></script>
    <style>
        .file-preview-frame{width: 180px;}
    </style>
    <script type="text/javascript">
        toastr.options = {
            "closeButton": true, //是否显示关闭按钮
            "positionClass": "toast-top-right", //弹出窗的位置
            "showDuration": "300", //显示的动画时间
            "hideDuration": "300", //消失的动画时间
            "timeOut": "3000", //展现时间
            "showEasing": "swing", //显示时的动画缓冲方式
            "hideEasing": "linear", //消失时的动画缓冲方式
            "showMethod": "fadeIn", //显示时的动画方式
            "hideMethod": "fadeOut" //消失时的动画方式
        };
        var rowData = 0;
        /**
         * 点击变色
         */
        $(document).on('click', 'tr', function () {
            $(this).addClass('selected').siblings().removeClass('selected');
        });
        /**
         * 上传初始化
         */
        function initFileInput(){
            $("#txt_xlsx").fileinput({
                language: 'zh', //设置语言
                uploadUrl: '/employee/upload', //上传的地址
                allowedFileExtensions: ['xlsx'],//接收的文件后缀
                showPreview: true,             //展前预览
                showUpload: true,
                showCaption: true,//是否显示标题
                autoReplace:true,
                maxFileSize: 1024*100,//上传文件最大的尺寸
                maxFilesCount: 1,//
                dropZoneEnabled: true,//是否显示拖拽区域
                browseClass: "btn btn-primary", //按钮样式
                msgFilesTooMany: "选择上传的文件数量({n}) 超过允许的最大数值{m}！",
            }).on("fileuploaded", function(event, data) {
                toastr.success("文件导入成功");
                $('#uploadModal').modal('hide');
                reload();
            }).on('fileuploaderror', function(event, data, msg) {  //一个文件上传失败
                toastr.error("网络繁忙上传失败请稍后再试");
            });
        }
        /**
         * 表格初始化方法
         * @returns {Object}
         * @constructor
         */
        var TableInit = function () {
            var oTableInit = new Object();
            //初始化Table
            oTableInit.Init = function () {
                $('#mytable').bootstrapTable({
                    url: '/employee/list',
                    method: 'post',
                    contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                    toolbar: '.toolbar',                //工具按钮用哪个容器
                    toolbarAlign: 'left',
                    cache: false,                       //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
                    pagination: true,                   //是否显示分页（*）
                    sortable: true,                     //是否启用排序
                    sidePagination: "client",           //分页方式：client客户端分页，server服务端分页（*）
                    pageNumber: 1,                       //初始化加载第一页，默认第一页
                    pageSize: 8,                       //每页的记录行数（*）
                    pageList: [8, 15, 20, 25],        //可供选择的每页的行数（*）
                    search: true,                       //是否显示表格搜索
                    showColumns: true,                  //是否显示所有的列
                    minimumCountColumns: 2,             //最少允许的列数
                    //height: 800,
                    singleSelect: true, 				//单行选中，一次只能选择一行
                    clickToSelect: true,
                    sortName: 'employeeCode',
                    sortOrder: 'asc',

                    onClickCell: function (index, value, row) {
                        rowData = row;
                    },
                    showToggle: true,                    //是否显示详细视图和列表视图的切换按钮
                    queryParams: function (params) { //查询字段，每次选择下拉菜单的时候，重新刷新表格就行
                        return {
                            status: $("#sel_status").val(),
                        }
                    },
                    columns: [
                        {
                            title: '序号',
                            align: 'center',
                            formatter: function (value, row, index) {
                                return index + 1;
                            }
                        },{
                            field: 'status',
                            title: '认证状态',
                            sortable: true,
                            align: "center",
                            formatter : function(value, row, index) {
                                if (value == 1) {
                                    return '已认证';
                                } else {
                                    return '未认证';
                                }
                            },
                        }, {
                            field: 'activeId',
                            title: '认证id',
                            sortable: true,
                            align: "center",
                            visible: false,
                        },{
                            field: 'employeeCode',
                            title: '工号',
                            sortable: true,
                            align: "center"
                        }, {
                            field: 'employeeName',
                            title: '姓名',
                            sortable: true,
                            align: "center"
                        }, {
                            field: 'employeeIdCard',
                            title: '身份证后6位',
                            sortable: true,
                            align: "center"
                        }, {
                            field: 'description',
                            title: '所属企业',
                            sortable: true,
                            align: "center",
                        },{
                            field: 'userId',
                            title: '用户ID',
                            sortable: true,
                            align: "center",
                            formatter : function(value, row, index) {
                                if (value == 0) {
                                    return '-';
                                } else {
                                    return value;
                                }
                            },
                        }, {
                            field: 'nickname',
                            title: '昵称',
                            sortable: true,
                            align: "center"
                        },{
                            field: 'operate',
                            title: '操作',
                            align: 'center',
                            valign: 'middle',
                            width: 200,
                            events: {
                                'click #edit': function (e, value, row, index) {
                                    $("#myModalLabel").text("信息编辑");
                                    $("#txt_activeId").val(row.activeId);
                                    $("#txt_employeeCode").val(row.employeeCode);
                                    $("#txt_employeeName").val(row.employeeName);
                                    $("#txt_employeeIdCard").val(row.employeeIdCard);
                                    $("#txt_description").val(row.description);
                                    $("#btn_submit").attr("onclick","edit()");
                                    $('#myModal').modal();
                                },
                                'click #delete': function (e, value, row, index) {
                                    confirmDelete(row.activeId);
                                }
                            },
                            formatter: function (value, row, index) {
                                var result = "";
                                if(row.status == 1){
                                    result += '<button id="edit" class="btn btn-info" data-toggle="modal" data-target="#editModal" style="margin-left:10px;" disabled>编辑</button>';
                                    result += '<button id="delete" class="btn btn-danger" style="margin-left:10px;" disabled>删除</button>';
                                }else {
                                    result += '<button id="edit" class="btn btn-info" data-toggle="modal" data-target="#editModal" style="margin-left:10px;">编辑</button>';
                                    result += '<button id="delete" class="btn btn-danger" style="margin-left:10px;">删除</button>';
                                }
                                return result;
                            }
                        }],
                })
            };

            return oTableInit;
        }

        /**
         * 表格重加载方法
         */
        function reload(){
            $("#mytable").bootstrapTable('refresh');
            rowData = 0;
        }

    </script>
</head>
<body>
<div class="row">
    <div class="col-xs-12 col-md-12">
        <div class="widget">
            <div class="widget-body">

                <div class="toolbar">
                    <H5 style="float:left;margin-right: 5px">认证状态:</H5>
                    <select class="form-control" style="width:180px;float:left;margin-right: 5px" id="sel_status" onchange="reload()">
                        <option value = "0">全部</option>
                        <option value = "1">已认证</option>
                        <option value = "2">未认证</option>
                    </select>
                    <button class="btn btn-default" onclick="openAddWin()"><i class="glyphicon glyphicon-plus"></i>添加</button>
                    <button class="btn  btn-primary" onclick="openUploadWin()" title="批量导入"><i class="glyphicon glyphicon-plus"></i>批量导入</button>
                    <button class="btn  btn-default" onclick="downModel()" title="导入模板"><i class="glyphicon glyphicon-download"></i>模板下载</button>
                </div>
                <table class="table " id="mytable">

                </table>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form id="txt_form">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                <h4 class="modal-title" id="myModalLabel">信息上传</h4>
            </div>
            <div class="modal-body" style="float:left">
                <div class="form-group" style="width:570px;float:left" hidden>
                    <label for="txt_activeId">认证id</label>
                    <input type="text" name="activeId" class="form-control" id="txt_activeId" placeholder="认证id">
                </div>
                <div class="form-group" style="width:570px;float:left">
                    <label for="txt_employeeCode">员工工号</label>
                    <input type="number" name="employeeCode" class="form-control" id="txt_employeeCode" placeholder="员工工号">
                </div>
                <div class="form-group" style="width:570px;float:left" >
                    <label for="txt_employeeName">员工姓名</label>
                    <input type="text" name="employeeName" class="form-control" id="txt_employeeName" placeholder="员工姓名">
                </div>
                <div class="form-group" style="width:570px;float:left" >
                    <label for="txt_employeeIdCard">身份证后6位</label>
                    <input type="text" name="employeeIdCard" class="form-control" id="txt_employeeIdCard" placeholder="身份证后6位">
                </div>
                <div class="form-group" style="width:570px;float:left" >
                    <label for="txt_description">企业名称</label>
                    <input type="text" name="description" class="form-control" id="txt_description" placeholder="企业名称">
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span>关闭</button>
                <button type="button" onclick="uploadCourse()" class="btn btn-primary" id="btn_submit"><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>保存</button>
            </div>
            </form>
        </div>
    </div>

</div>

<div class="modal fade" id="uploadModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                    <h4 class="modal-title" id="uploadModalLabel">信息导入</h4>
                </div>
                <div class="modal-body" style="float:left" id="div_insert_file">
                    <div class="form-group" style="width:570px;float:left" >
                    <label for="txt_xlsx">xlsx文件导入</label>
                    <input type="file" name="file" class="form-control" id="txt_xlsx" placeholder="请选择xlsx文件">
                    </div>

                </div>
                <div class="modal-footer">
                </div>
        </div>
    </div>
</div>
<script>
    var oTable = new TableInit();
    oTable.Init();
    initFileInput();
    /**
     * 打开信息上传窗口
     */
    function openAddWin(){
        $("#myModalLabel").text("信息上传");
        $("#txt_activeId").val("");
        $("#txt_employeeCode").val("");
        $("#txt_employeeName").val("");
        $("#txt_employeeIdCard").val("");
        $("#txt_description").val("");
        $("#btn_submit").attr("onclick","add()");
        $('#myModal').modal();
    }

    /**
     * 信息上传
     */
    function add(){
        if ($("#txt_employeeCode").val() == null || $("#txt_employeeCode").val().trim() == "") {
            toastr.warning("工号不能为空");
        } else if ($("#txt_employeeName").val() == null || $("#txt_employeeName").val().trim() == "") {
            toastr.warning("姓名不能为空");
        } else if ($("#txt_employeeIdCard").val() == null || $("#txt_employeeIdCard").val().trim() == "" || $("#txt_employeeIdCard").val().length != 6) {
            toastr.warning("身份证后6位不能为空且需为6位");
        } else {
            $("#btn_submit").prop("disabled",true);
            $.ajax({
                url: "employee/add",
                data: new FormData($("#txt_form")[0]),
                type: "POST",
                // 告诉jQuery不要去处理发送的数据，用于对data参数进行序列化处理 这里必须false
                processData: false,
                // 告诉jQuery不要去设置Content-Type请求头
                contentType: false,
                dataType: "json",
                success: function (d) {
                    $("#btn_submit").prop("disabled",false);
                    if (d == 0) {
                        reload();
                        $('#myModal').modal('hide');
                        toastr.success("添加成功");
                    }else {
                        toastr.warning("工号已存在,请重新添加");
                    }
                },
                error: function (json) {
                    toastr.warning("网络繁忙,请稍后再试");
                    $("#btn_submit").prop("disabled",false);
                }
            });
        }
    }
    /**
     * 打开信息导入窗口
     */
    function openUploadWin(){
        $("#div_insert_file").empty();
        $("#div_insert_file").append('<div class="form-group" style="width:570px;float:left" >\n' +
            '                    <label for="txt_xlsx">xlsx文件导入</label>\n' +
            '                    <input type="file" name="file" class="form-control" id="txt_xlsx" placeholder="请选择xlsx文件">\n' +
            '                    </div>');
        initFileInput();
        $('#uploadModal').modal();
    }
    /**
     * 信息编辑
     */
    function edit(){
        if ($("#txt_employeeCode").val() == null || $("#txt_employeeCode").val().trim() == "") {
            toastr.warning("工号不能为空");
        } else if ($("#txt_employeeName").val() == null || $("#txt_employeeName").val().trim() == "") {
            toastr.warning("姓名不能为空");
        } else if ($("#txt_employeeIdCard").val() == null || $("#txt_employeeIdCard").val().trim() == "" || $("#txt_employeeIdCard").val().length != 6) {
            toastr.warning("身份证后6位不能为空且需为6位");
        } else {
            $("#btn_submit").prop("disabled",true);
            $.ajax({
                url: "employee/edit",
                data: new FormData($("#txt_form")[0]),
                type: "POST",
                // 告诉jQuery不要去处理发送的数据，用于对data参数进行序列化处理 这里必须false
                processData: false,
                // 告诉jQuery不要去设置Content-Type请求头
                contentType: false,
                dataType: "json",
                success: function (d) {
                    $("#btn_submit").prop("disabled",false);
                    if (d == 0) {
                        reload();
                        $('#myModal').modal('hide');
                        toastr.success("修改成功");
                    } else {
                        toastr.warning("系统开小差啦,请联系管理员");
                    }
                },
                error: function (json) {
                    toastr.warning("网络繁忙,请稍后再试");
                    $("#btn_submit").prop("disabled",false);
                }
            });
        }
    }

    /**
     * 删除弹窗
     * @param activeId
     */
    function confirmDelete(activeId){
        bootbox.confirm({
            size: "small",
            message: "确认删除信息吗?",
            buttons: {
                confirm: {
                    label: '确定',
                    className: 'btn-success'
                },
                cancel: {
                    label: '取消',
                    className: 'btn-danger'
                }
            },
            callback: function (result) { /* result is a boolean; true = OK, false = Cancel*/
                if (result) {
                    deleteCourse(activeId);
                } else {
                }
            }
        });
    }
    /**
     * 信息删除
     * @param activeId
     */
    function deleteCourse(activeId){
        $.ajax({
            url:"employee/delete",
            method:"post",
            data:{
                activeId:activeId,
            },
            dataType:"json",
            success:function(d){
                if (d == 0) {
                    reload();
                    toastr.success("信息删除成功");
                } else {
                    toastr.warning("系统开小差啦,请联系管理员");
                }
            },
            error:function(){
                toastr.warning("网络繁忙,请稍后再试")
            }
        })
    }

    function downModel(){
        var url="/employee/downModel?fileName=企业用户信息上传模板.xlsx";
        window.open(url);//跳转后台的路径
    }
</script>
</body>
</html>