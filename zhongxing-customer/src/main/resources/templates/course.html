<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>课程管理</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet"/>
    <link id="bootstrap-rtl-link" href="" rel="stylesheet"/>
    <link href="/css/font-awesome.min.css" rel="stylesheet"/>
    <link href="/css/weather-icons.min.css" rel="stylesheet"/>

    <link
            href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300"
            rel="stylesheet" type="text/css">

    <link href="/css/demo.min.css" rel="stylesheet"/>
    <link href="/css/typicons.min.css" rel="stylesheet"/>
    <link href="/css/animate.min.css" rel="stylesheet"/>
    <link href="/css/bootstrap-table.css" rel="stylesheet"/>
    <link href="/css/toastr.css" rel="stylesheet"/>
    <link href="/css/fileinput.min.css" rel="stylesheet"/>

    <script src="/js/jquery-2.0.3.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/bootstrap-table.js?t=4"></script>
    <script src="/js/bootstrap-table-zh-CN.js"></script>
    <script src="/js/toastr.js"></script>
    <script src="/js/bootbox.min.js"></script>
    <script src="/js/bootstrap-datetimepicker.min.js"></script>
    <script src="/js/fileinput.min.js"></script>
    <script src="/js/fileinput_local_zh.js"></script>
    <style>
        .file-preview-frame{width: 180px;}
    </style>
    <script type="text/javascript">
        toastr.options = {
            "closeButton": true, //是否显示关闭按钮
            "positionClass": "toast-top-right", //弹出窗的位置
            "showDuration": "300", //显示的动画时间
            "hideDuration": "300", //消失的动画时间
            "timeOut": "3000", //展现时间
            "showEasing": "swing", //显示时的动画缓冲方式
            "hideEasing": "linear", //消失时的动画缓冲方式
            "showMethod": "fadeIn", //显示时的动画方式
            "hideMethod": "fadeOut" //消失时的动画方式
        };
        var rowData = 0;
        /**
         * 点击变色
         */
        $(document).on('click', 'tr', function () {
            $(this).addClass('selected').siblings().removeClass('selected');
        });
        /**
         * 表格初始化方法
         * @returns {Object}
         * @constructor
         */
        var TableInit = function () {
            var oTableInit = new Object();
            //初始化Table
            oTableInit.Init = function () {
                $('#mytable').bootstrapTable({
                    url: '/course/list',
                    method: 'post',
                    contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                    toolbar: '.toolbar',                //工具按钮用哪个容器
                    toolbarAlign: 'left',
                    cache: false,                       //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
                    pagination: true,                   //是否显示分页（*）
                    sortable: true,                     //是否启用排序
                    sidePagination: "client",           //分页方式：client客户端分页，server服务端分页（*）
                    pageNumber: 1,                       //初始化加载第一页，默认第一页
                    pageSize: 8,                       //每页的记录行数（*）
                    pageList: [8, 15, 20, 25],        //可供选择的每页的行数（*）
                    search: true,                       //是否显示表格搜索
                    showColumns: true,                  //是否显示所有的列
                    minimumCountColumns: 2,             //最少允许的列数
                    //height: 800,
                    singleSelect: true, 				//单行选中，一次只能选择一行
                    clickToSelect: true,
                    sortName: 'structureId',
                    sortOrder: 'asc',

                    onClickCell: function (index, value, row) {
                        rowData = row;
                    },
                    showToggle: true,                    //是否显示详细视图和列表视图的切换按钮
                    queryParams: function (params) { //查询字段，每次选择下拉菜单的时候，重新刷新表格就行
                        return {
                            structureId: $("#sel_lowStructure").val(),
                        }
                    },
                    columns: [
                        {
                            field: 'sequence',
                            title: '课程排序',
                            sortable: true,
                            align: "center",
                        }, {
                            field: 'courseId',
                            title: '课程id',
                            sortable: true,
                            align: "center",
                            visible: false,
                        },{
                            field: 'courseCode',
                            title: '课程编码',
                            sortable: true,
                            align: "center"
                        }, {
                            field: 'courseName',
                            title: '课程名称',
                            sortable: true,
                            align: "center"
                        }, {
                            field: 'structureName',
                            title: '课程类别',
                            sortable: true,
                            align: "center"
                        }, {
                            field: 'structureId',
                            title: '类别id',
                            sortable: true,
                            align: "center",
                            visible: false,
                        },{
                            field: 'duration',
                            title: '时长',
                            sortable: true,
                            align: "center",
                            visible: false,
                        }, {
                            field: 'playNum',
                            title: '播放量',
                            sortable: true,
                            align: "center"
                        }, {
                            field: 'createDate',
                            title: '创建时间',
                            sortable: true,
                            align: "center",
                        }, {
                            field: 'teacher',
                            title: '主讲人',
                            sortable: true,
                            align: "center",
                            visible: false,
                        },{
                            field: 'operate',
                            title: '操作',
                            align: 'center',
                            valign: 'middle',
                            width: 200,
                            events: {
                                'click #edit': function (e, value, row, index) {
                                    $("#myModalLabel").text("课程编辑");
                                    $("#txt_courseId").val(row.courseId);
                                    $("#txt_courseCode").val(row.courseCode);
                                    $("#txt_courseName").val(row.courseName);
                                    $("#txt_sequence").val(row.sequence);
                                    $("#txt_duration").val(row.duration);
                                    $("#txt_video").val("");
                                    $("#txt_cover").val("");
                                    $(".fileinput-remove-button").click();
                                    $("#container_structure").prop("hidden",true);
                                    $("#txt_teacher").val(row.teacher);
                                    $("#btn_submit").attr("onclick","editCourse()");
                                    $('#myModal').modal();
                                },
                                'click #delete': function (e, value, row, index) {
                                    confirmDelete(row.courseId);
                                }
                            },
                            formatter: function (value, row, index) {
                                var result = "";
                                result += '<button id="edit" class="btn btn-info" data-toggle="modal" data-target="#editModal" style="margin-left:10px;">编辑</button>';
                                result += '<button id="delete" class="btn btn-danger" style="margin-left:10px;">删除</button>';
                                return result;
                            }
                        }],
                })
            };

            return oTableInit;
        }

        /**
         * 表格重加载方法
         */
        function reload(){
            $("#mytable").bootstrapTable('refresh');
            rowData = 0;
        }

    </script>
</head>
<body>
<div class="row">
    <div class="col-xs-12 col-md-12">
        <div class="widget">
            <div class="widget-body">

                <div class="toolbar">
                    <H5 style="float:left;margin-right: 5px">课程分类:</H5>
                    <select class="form-control" style="width:180px;float:left;margin-right: 5px" id="sel_highStructure" onchange="changeMidStructure()">
                        <option value = "0">选择大类</option>
                        <option value = "1">IT编程</option>
                        <option value = "2">产品经理</option>
                    </select>
                    <select class="form-control" style="width:180px;float:left;margin-right: 5px" id="sel_midStructure" onchange="changeLowStructure()">
                        <option value = "0">选择中类</option>
                    </select>
                    <select class="form-control" style="width:180px;float:left;margin-right: 5px" id="sel_lowStructure" onchange="reload()">
                        <option value = "0">选择小类</option>
                    </select>

                    <button class="btn  btn-primary" onclick="openUploadWin()" title="上传课程"><i class="glyphicon glyphicon-plus"></i>上传课程</button>
                </div>
                <table class="table " id="mytable">

                </table>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form id="txt_form" enctype="multipart/form-data">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                <h4 class="modal-title" id="myModalLabel">课程上传</h4>
            </div>
            <div class="modal-body" style="float:left">
                <div class="form-group" style="width:250px;float:left" hidden>
                    <label for="txt_courseId">课程id</label>
                    <input type="text" name="courseId" class="form-control" id="txt_courseId" placeholder="课程id">
                </div>
                <div class="form-group" style="width:250px;float:left" hidden>
                    <label for="txt_courseCode">课程编码</label>
                    <input type="text" name="courseCode" class="form-control" id="txt_courseCode" placeholder="课程编码">
                </div>
                <div class="form-group" style="width:570px;float:left" >
                    <label for="txt_courseName">课程名称</label>
                    <input type="text" name="courseName" class="form-control" id="txt_courseName" placeholder="课程名称">
                </div>
                <div class="form-group" style="width:250px;float:left" >
                    <label for="txt_sequence">课程排序</label>
                    <input type="number" name="sequence" class="form-control" id="txt_sequence" placeholder="课程排序">
                </div>
                <div class="form-group" style="width:250px;float:right" >
                    <label for="txt_teacher">主讲人</label>
                    <input type="text" name="teacher" class="form-control" id="txt_teacher" placeholder="主讲人姓名">
                </div>
                <div class="form-group" id="container_structure" style="width:570px;float:left" >
                    <label for="txt_structure">课程分类</label>
                    <div id="txt_structure">
                    <select class="form-control" style="width:180px;float:left;margin-right: 10px" id="txt_highStructure" onchange="changeTxtMidStructure()">
                        <option value = "0">选择大类</option>
                        <option value = "1">IT编程</option>
                        <option value = "2">产品经理</option>
                    </select>
                    <select class="form-control" style="width:180px;float:left;margin-right: 10px" id="txt_midStructure" onchange="changeTxtLowStructure()">
                        <option value = "0">选择中类</option>
                    </select>
                    <select name="structureId" class="form-control" style="width:180px;float:left;margin-right: 5px" id="txt_lowStructure">
                        <option value = "0">选择小类</option>
                    </select>
                    </div>
                </div>
                <div class="form-group" style="width:570px;float:left" >
                    <label for="txt_video">视频上传</label>
                    <input type="file" name="file1" class="form-control" id="txt_video" placeholder="请选择视频">
                </div>
                <div class="form-group" style="width:570px;float:left" >
                    <label for="txt_duration">课程时长(秒)</label>
                    <input type="number" name="duration" class="form-control" id="txt_duration" placeholder="视频时长,单位为秒">
                </div>
                <div class="form-group" style="width:570px;float:left" >
                    <label for="txt_cover">封面上传</label>
                    <input type="file" name="file2" class="form-control" id="txt_cover" placeholder="请选择封面">
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span>关闭</button>
                <button type="button" onclick="uploadCourse()" class="btn btn-primary" id="btn_submit"><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>保存</button>
            </div>
            </form>
        </div>
    </div>
</div>
<script>
    var oTable = new TableInit();
    oTable.Init();
    /**
     * 视频上传初始化
     */
    $("#txt_video").fileinput({
        language: 'zh', //设置语言
        allowedFileExtensions: ['mp4'],//接收的文件后缀
        showPreview: false,              //展前预览
        showUpload: false,
        autoReplace:true,
        maxFileSize: 1024*200,//上传文件最大的尺寸
        maxFilesCount: 1,//
        dropZoneEnabled: true,//是否显示拖拽区域
        browseClass: "btn btn-primary", //按钮样式
        msgFilesTooMany: "选择上传的文件数量({n}) 超过允许的最大数值{m}！",
    })
    /**
     * 图片上传初始化
     */
    $("#txt_cover").fileinput({
        language: 'zh', //设置语言
        allowedFileExtensions: ['jpg', 'png', 'bmp', 'jpeg'],//接收的文件后缀
        showPreview: false,             //展前预览
        showUpload: false,
        autoReplace:true,
        maxFileSize: 1024,//上传文件最大的尺寸
        maxFilesCount: 1,//
        dropZoneEnabled: true,//是否显示拖拽区域
        browseClass: "btn btn-primary", //按钮样式
        previewSettings: {image: {width: "100px", height: "100px"},},
        msgFilesTooMany: "选择上传的文件数量({n}) 超过允许的最大数值{m}！",
    })
    /**
     * 大类变更刷新中类及小类下拉框内容
     */
    function changeMidStructure(){
        var pid = $("#sel_highStructure").val();
        if(pid == "0"){
            $("#sel_midStructure").empty();
            $("#sel_midStructure").append('<option value = "0">选择中类</option>');
            changeLowStructure();
        }else{
            $.ajax({
                url:"structure/listByPid",
                method:"post",
                data:{
                    pid: pid,
                },
                dataType:"json",
                success:function (d){
                    $("#sel_midStructure").empty();
                    if(d != null && d != ""){
                        $(d).each(function(k,v){
                            $("#sel_midStructure").append('<option value = "' + v.structureId + '">' + v.structureName + '</option>');
                        })
                    }else{
                        $("#sel_midStructure").append('<option value = "-1">无中类数据</option>');
                    }
                    changeLowStructure();
                },
                error : function() {
                    toastr.warning("网络繁忙,请稍后再试");
                }
            })
        }
    }

    /**
     * 中类变更刷新小类下拉框内容
     */
    function changeLowStructure(){
        var pid = $("#sel_midStructure").val();
        if(pid == "0"){
            $("#sel_lowStructure").empty();
            $("#sel_lowStructure").append('<option value = "0">选择小类</option>');
            reload();
        }else if(pid == "-1"){
            $("#sel_lowStructure").empty();
            $("#sel_lowStructure").append('<option value = "-1">无小类数据</option>');
            reload();
        }else{
            $.ajax({
                url:"structure/listByPid",
                method:"post",
                data:{
                    pid: pid,
                },
                dataType:"json",
                success:function (d){
                    $("#sel_lowStructure").empty();
                    if(d != null && d != ""){
                        $(d).each(function(k,v){
                            $("#sel_lowStructure").append('<option value = "' + v.structureId + '">' + v.structureName + '</option>');
                        })
                    }else{
                        $("#sel_lowStructure").append('<option value = "-1">无小类数据</option>');
                    }
                    reload();
                },
                error : function() {
                    toastr.warning("网络繁忙,请稍后再试");
                },
            })
        }
    }
    /**
     * 级联更改弹窗内中类
     */
    function changeTxtMidStructure(){
        var pid = $("#txt_highStructure").val();
        if(pid == "0"){
            $("#txt_midStructure").empty();
            $("#txt_midStructure").append('<option value = "0">选择中类</option>');
            changeTxtLowStructure();
        }else{
            $.ajax({
                url:"structure/listByPid",
                method:"post",
                data:{
                    pid: pid,
                },
                dataType:"json",
                success:function (d){
                    $("#txt_midStructure").empty();
                    if(d != null && d != ""){
                        $(d).each(function(k,v){
                            $("#txt_midStructure").append('<option value = "' + v.structureId + '">' + v.structureName + '</option>');
                        })
                    }else{
                        $("#txt_midStructure").append('<option value = "-1">无中类数据</option>');
                    }
                    changeTxtLowStructure();
                },
                error : function() {
                    toastr.warning("网络繁忙,请稍后再试");
                }
            })
        }
    }
    /**
     * 级联更改弹窗内小类下拉框内容
     */
    function changeTxtLowStructure(){
        var pid = $("#txt_midStructure").val();
        if(pid == "0"){
            $("#txt_lowStructure").empty();
            $("#txt_lowStructure").append('<option value = "0">选择小类</option>');
            reload();
        }else if(pid == "-1"){
            $("#txt_lowStructure").empty();
            $("#txt_lowStructure").append('<option value = "-1">无小类数据</option>');
            reload();
        }else{
            $.ajax({
                url:"structure/listByPid",
                method:"post",
                data:{
                    pid: pid,
                },
                dataType:"json",
                success:function (d){
                    $("#txt_lowStructure").empty();
                    if(d != null && d != ""){
                        $(d).each(function(k,v){
                            $("#txt_lowStructure").append('<option value = "' + v.structureId + '">' + v.structureName + '</option>');
                        })
                    }else{
                        $("#txt_lowStructure").append('<option value = "-1">无小类数据</option>');
                    }
                    reload();
                },
                error : function() {
                    toastr.warning("网络繁忙,请稍后再试");
                },
            })
        }
    }
    /**
     * 打开课程上传窗口
     */
    function openUploadWin(){
        $("#myModalLabel").text("课程上传");
        $("#txt_courseId").val("");
        $("#txt_courseCode").val("");
        $("#txt_courseName").val("");
        $("#txt_sequence").val("");
        $("#txt_video").val("");
        $("#txt_duration").val("");
        $("#txt_cover").val("");
        $("#container_structure").prop("hidden",false);
        $(".fileinput-remove-button").click();
        $("#txt_highStructure").val($("#sel_highStructure").val());
        changeTxtMidStructure();
        $("#txt_midStructure").val($("#sel_midStructure").val());
        changeTxtLowStructure();
        $("#txt_lowStructure").val($("#sel_lowStructure").val());
        $("#txt_teacher").val("");
        $("#btn_submit").attr("onclick","uploadCourse()");
        $('#myModal').modal();
    }

    /**
     * 课程上传
     */
    function uploadCourse(){
        if ($("#txt_courseName").val() == null || $("#txt_courseName").val().trim() == "") {
            toastr.warning("课程名称不能为空");
        } else if ($("#txt_sequence").val() == null || $("#txt_sequence").val().trim() == "") {
            toastr.warning("课程排序不能为空");
        } else if ($("#txt_teacher").val() == null || $("#txt_teacher").val().trim() == "") {
            toastr.warning("主讲人不能为空");
        } else if($("#txt_lowStructure").val() == 0){
            toastr.warning("请选择课程分类");
        } else if ($("#txt_video").val() == null || $("#txt_video").val().trim() == "") {
            toastr.warning("请上传课程视频");
        } else if ($("#txt_cover").val() == null || $("#txt_cover").val().trim() == "") {
            toastr.warning("请上传封面");
        } else {
            $("#btn_submit").prop("disabled",true);
            $.ajax({
                url: "course/upload",
                data: new FormData($("#txt_form")[0]),
                type: "POST",
                // 告诉jQuery不要去处理发送的数据，用于对data参数进行序列化处理 这里必须false
                processData: false,
                // 告诉jQuery不要去设置Content-Type请求头
                contentType: false,
                dataType: "json",
                success: function (d) {
                    $("#btn_submit").prop("disabled",false);
                    if (d == 0) {
                        reload();
                        $('#myModal').modal('hide');
                        toastr.success("分类添加成功");
                    } else if(d == 2) {
                        toastr.warning("请添加课程视频及封面");
                    } else {
                        toastr.warning("系统开小差啦,请联系管理员");
                    }
                },
                error: function (json) {
                    toastr.warning("网络繁忙,请稍后再试");
                    $("#btn_submit").prop("disabled",false);
                }
            });
        }
    }

    /**
     * 课程编辑
     */
    function editCourse(){
        if ($("#txt_courseName").val() == null || $("#txt_courseName").val().trim() == "") {
            toastr.warning("课程名称不能为空");
        } else if ($("#txt_sequence").val() == null || $("#txt_sequence").val().trim() == "") {
            toastr.warning("课程排序不能为空");
        } else if ($("#txt_teacher").val() == null || $("#txt_teacher").val().trim() == "") {
            toastr.warning("主讲人不能为空");
        } else {
            $("#btn_submit").prop("disabled",true);
            $.ajax({
                url: "course/edit",
                data: new FormData($("#txt_form")[0]),
                type: "POST",
                // 告诉jQuery不要去处理发送的数据，用于对data参数进行序列化处理 这里必须false
                processData: false,
                // 告诉jQuery不要去设置Content-Type请求头
                contentType: false,
                dataType: "json",
                success: function (d) {
                    $("#btn_submit").prop("disabled",false);
                    if (d == 0) {
                        reload();
                        $('#myModal').modal('hide');
                        toastr.success("分类编辑成功");
                    } else {
                        toastr.warning("系统开小差啦,请联系管理员");
                    }
                },
                error: function (json) {
                    toastr.warning("网络繁忙,请稍后再试");
                    $("#btn_submit").prop("disabled",false);
                }
            });
        }
    }

    /**
     * 删除弹窗
     * @param courseId
     */
    function confirmDelete(courseId){
        bootbox.confirm({
            size: "small",
            message: "确认删除课程吗?",
            buttons: {
                confirm: {
                    label: '确定',
                    className: 'btn-success'
                },
                cancel: {
                    label: '取消',
                    className: 'btn-danger'
                }
            },
            callback: function (result) { /* result is a boolean; true = OK, false = Cancel*/
                if (result) {
                    deleteCourse(courseId);
                } else {
                }
            }
        });
    }
    /**
     * 课程删除
     * @param courseId
     */
    function deleteCourse(courseId){
        $.ajax({
            url:"course/delete",
            method:"post",
            data:{
                courseId:courseId,
            },
            dataType:"json",
            success:function(d){
                if (d == 0) {
                    reload();
                    toastr.success("课程删除成功");
                } else {
                    toastr.warning("系统开小差啦,请联系管理员");
                }
            },
            error:function(){
                toastr.warning("网络繁忙,请稍后再试")
            }
        })
    }
</script>
</body>
</html>